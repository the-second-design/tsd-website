---
import Layout from '~/layouts/PageLayout.astro';

import testimonialsData from '~/data/testimonials.json';
import personsData from '~/data/persons.json';
import productsData from '~/data/products.json';

const metadata = {
  title: 'Testimonials — The Second Design',
  description:
    'What partners, organisations, and learners say about working with The Second Design.',
};

interface Testimonial {
  testimonial_id: string;
  person_id: string | null;
  product_ids?: string[];
  partner_ids?: string[];
  quote_short: string;
  source_type: string;
  source_url: string | null;
  audience_type?: string | null;
  scope?: string;
  priority?: string | null;
  language?: string | null;
  date?: string | null;
  is_published?: boolean;
}

interface Person {
  person_id: string;
  person_name: string;
  person_designation: string | null;
  person_company: string | null;
  person_partner_id?: string | null;
  person_relationship_type?: string | null;
}

interface Product {
  product_id: string;
  product_name?: string | null;
  product_category?: string | null;
  product_variant_name?: string | null;
  brand_label?: string | null;
  name?: string | null;
}

const testimonials = (testimonialsData as Testimonial[]).filter(
  (t) => t.is_published !== false
);

const persons = personsData as Person[];
const products = productsData as Product[];

const personsMap = new Map(persons.map((p) => [p.person_id, p]));
const productsMap = new Map(products.map((p) => [p.product_id, p]));

function getProductLabelFromId(productId: string | null): string {
  if (!productId || productId === 'generic-brand') {
    return 'The Second Design – Brand';
  }

  const p = productsMap.get(productId);
  if (!p) return 'The Second Design – Brand';

  return (
    p.product_name ||
    p.product_variant_name ||
    p.brand_label ||
    p.name ||
    'The Second Design – Brand'
  );
}

function getProductLabelForTestimonial(t: Testimonial): string {
  const firstId =
    t.product_ids && t.product_ids.length > 0 ? t.product_ids[0] : 'generic-brand';
  return getProductLabelFromId(firstId);
}

function getPerson(t: Testimonial): Person | null {
  if (!t.person_id) return null;
  return personsMap.get(t.person_id) ?? null;
}

function getAudienceLabel(t: Testimonial, person: Person | null): string {
  if (person?.person_name) return person.person_name;
  if (t.audience_type) {
    const a = t.audience_type;
    return a.charAt(0).toUpperCase() + a.slice(1);
  }
  return 'Learner';
}

function getSourceLabel(t: Testimonial): string {
  switch (t.source_type) {
    case 'video':
      return 'Video';
    case 'blog':
      return 'Blog';
    case 'email':
      return 'Email';
    case 'text':
    default:
      return 'Text';
  }
}

function getSourceCta(t: Testimonial): string {
  switch (t.source_type) {
    case 'video':
      return 'Watch video';
    case 'blog':
      return 'Read blog';
    case 'email':
      return 'View note';
    default:
      return 'Open';
  }
}

function extractYouTubeId(url: string | null): string | null {
  if (!url) return null;
  try {
    const u = new URL(url);
    if (u.hostname === 'youtu.be') {
      return u.pathname.slice(1);
    }
    const v = u.searchParams.get('v');
    if (v) return v;
    if (u.pathname.startsWith('/embed/')) {
      const parts = u.pathname.split('/');
      return parts[2] || null;
    }
    return null;
  } catch {
    return null;
  }
}

// Fisher–Yates shuffle – randomness at build time
function shuffle<T>(arr: T[]): T[] {
  const copy = [...arr];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// Shuffle all published testimonials
const shuffledTestimonials = shuffle(testimonials);
---

<Layout metadata={metadata}>

  <!-- Hero -->
  <section class="py-24 text-center bg-white dark:bg-slate-950">
    <div class="container max-w-3xl mx-auto space-y-6 px-4 sm:px-6">
      <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-slate-900 dark:text-slate-50">
        Testimonials
      </h1>
      <p class="text-lg sm:text-xl text-slate-700 dark:text-slate-300 leading-relaxed">
        A mixed wall of voices from partners, organisers, and learners who’ve been through our programs and consulting work.
      </p>
      <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
        Loaded in random order from our full testimonial library.
      </p>
    </div>
  </section>

  <!-- Masonry wall -->
  <section class="py-20 bg-slate-50 dark:bg-slate-950/70 border-y border-slate-200 dark:border-slate-800">
    <div class="container max-w-6xl mx-auto px-4 sm:px-6 space-y-8">

      <div class="columns-1 sm:columns-2 lg:columns-3 gap-6">
        {shuffledTestimonials.map((t) => {
          const person = getPerson(t);
          const audienceLabel = getAudienceLabel(t, person);
          const productLabel = getProductLabelForTestimonial(t);
          const sourceLabel = getSourceLabel(t);
          const youtubeId = extractYouTubeId(t.source_url);

          return (
            <article
              class="mb-6 break-inside-avoid rounded-2xl p-6 sm:p-7 border bg-white border-slate-200 shadow-sm shadow-slate-200/70 dark:bg-slate-900/70 dark:border-slate-800 dark:shadow-black/30 flex flex-col gap-4"
            >
              <div class="flex items-center justify-between gap-3">
                <div class="text-xs font-semibold tracking-wide text-blue-600 dark:text-blue-400 uppercase">
                  {productLabel}
                </div>

                <div class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-slate-100 text-[11px] font-medium text-slate-600 dark:bg-slate-800 dark:text-slate-300">
                  {sourceLabel}
                  {t.language && t.language !== 'en' && (
                    <span class="opacity-70">· {t.language.toUpperCase()}</span>
                  )}
                </div>
              </div>

              <p class="text-base sm:text-lg text-slate-800 dark:text-slate-100 leading-relaxed">
                “{t.quote_short}”
              </p>

              {/* Source-specific render */}
              {t.source_type === 'video' && youtubeId && (
                <div class="mt-1 aspect-video rounded-xl overflow-hidden border border-slate-200 dark:border-slate-800">
                  <iframe
                    src={`https://www.youtube.com/embed/${youtubeId}`}
                    title="Video testimonial"
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                    class="w-full h-full"
                  ></iframe>
                </div>
              )}

              {t.source_type === 'blog' && t.source_url && (
                <div class="mt-1">
                  <a
                    href={t.source_url}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center gap-1.5 text-xs font-semibold text-blue-600 dark:text-blue-400 hover:underline"
                  >
                    Read the full story
                    <span aria-hidden="true">↗</span>
                  </a>
                </div>
              )}

              {t.source_type === 'email' && t.source_url && (
                <div class="mt-1">
                  <a
                    href={t.source_url}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center gap-1.5 text-xs font-semibold text-blue-600 dark:text-blue-400 hover:underline"
                  >
                    View original note
                    <span aria-hidden="true">↗</span>
                  </a>
                </div>
              )}

              <div class="mt-3 flex items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <div class="h-9 w-9 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xs font-semibold text-slate-700 dark:text-slate-200">
                    {person?.person_name
                      ? person.person_name.charAt(0)
                      : audienceLabel.charAt(0)}
                  </div>
                  <div>
                    <div class="text-sm font-semibold text-slate-900 dark:text-slate-50">
                      {person?.person_name ?? audienceLabel}
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">
                      {person?.person_designation}
                      {person?.person_designation && person?.person_company ? ' · ' : ''}
                      {person?.person_company}
                    </div>
                  </div>
                </div>

                {t.source_url && !youtubeId && t.source_type !== 'blog' && (
                  <a
                    href={t.source_url}
                    target="_blank"
                    rel="noreferrer"
                    class="text-xs font-semibold text-blue-600 dark:text-blue-400 hover:underline whitespace-nowrap"
                  >
                    {getSourceCta(t)}
                  </a>
                )}
              </div>
            </article>
          );
        })}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="py-24 text-center bg-white dark:bg-slate-950">
    <div class="container max-w-3xl mx-auto space-y-6 px-4 sm:px-6">
      <h2 class="text-3xl font-semibold tracking-tight text-slate-900 dark:text-slate-50">
        Want to work with The Second Design?
      </h2>
      <p class="text-slate-700 dark:text-slate-300 text-base leading-relaxed">
        Whether you’re a college, NGO, foundation, or company, we’re happy to explore building a serious learning
        program with you.
      </p>

      <a
        href="/contact"
        class="inline-flex items-center justify-center rounded-xl
               bg-slate-900 text-slate-50 px-6 py-3 text-sm font-semibold
               shadow-lg shadow-blue-500/30 hover:bg-slate-800
               dark:bg-white dark:text-slate-900 dark:hover:bg-slate-100
               transition"
      >
        Book an inquiry call
      </a>
    </div>
  </section>

</Layout>